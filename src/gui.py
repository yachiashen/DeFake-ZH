import gradio as gr


try:
    from .scores import *
    from .interface import *
    from .otherGUI import *
except:
    from scores import *
    from interface import *
    from otherGUI import *


lang_options = {
    "ç¹é«”ä¸­æ–‡": {
        "title": "## ä¸­æ–‡å‡æ–°èåµæ¸¬å™¨",
        "description": "è¼¸å…¥ä¸€ç¯‡æ–°èæ¨™é¡Œèˆ‡å…§æ–‡ï¼Œç³»çµ±å°‡åˆ¤æ–·çœŸå‡æ©Ÿç‡èˆ‡åˆ†æèªæ°£",
        "input_title": "æ–°èæ¨™é¡Œ",
        "input_content": "æ–°èå…§æ–‡",
        "submit_btn": "-- å®Œæ•´åˆ†æ --",
        "quick_btn": "-- å¿«é€Ÿåˆ†æ --",
        "clear_btn": "-- æ¸…é™¤ --",
        "accordion_label": "é»æˆ‘å±•é–‹æŸ¥çœ‹è©³ç´°åˆ†æ",
        "result": "åˆ†æçµæœ",
        "disclaimer": "<div align='center'><small>âš ï¸ æœ¬ç³»çµ±åƒ…ä¾›åƒè€ƒï¼Œåˆ†æçµæœä¾†è‡ªæ©Ÿå™¨å­¸ç¿’æ¨¡å‹ï¼Œè«‹å‹¿è¦–ç‚ºæœ€çµ‚çœŸå¯¦ä¾æ“šã€‚ âš ï¸</small></div>"
    },
    "English": {
        "title": "## Fake News Detector for Chinese",
        "description": "Enter the headline and content to analyze its truthfulness and tone.",
        "input_title": "News Title",
        "input_content": "News Content",
        "submit_btn": "-- FULL ANALYSIS --",
        "quick_btn": "-- QUICK ANALYSIS --",
        "clear_btn": "-- CLEAR --",
        "accordion_label": "Click to show detailed analysis",
        "result": "Results",
        "disclaimer": "<div align='center'><small>âš ï¸ This system is for reference only. The analysis is generated by a machine learning model and should not be considered factual. âš ï¸</small></div>"
    }
}


def update_labels(language):
    config = lang_options[language]
    return (
        gr.update(label=config["input_title"]),
        gr.update(label=config["input_content"]),
        gr.update(label=config["result"]),
        gr.update(value=config["submit_btn"]),
        gr.update(value=config["quick_btn"]),
        gr.update(value=config["clear_btn"]),
        gr.Markdown(value=config["title"]),
        gr.update(value=config["description"]),
        gr.update(label=config["accordion_label"]),
        gr.update(value=config["disclaimer"])
    )

def interface_fn(title, content):
    print("\n\n======  é–‹å§‹å®Œæ•´åˆ†æ  ======\n\n")
    score = 0
    
    title, content = re.sub(r'\s+', '', title), re.sub(r'\s+', '', content)
    if not isinstance(content, str) or content == "" or title == "":
        yield " ğŸš¨\u3000è«‹è¼¸å…¥ã€æ¨™é¡Œã€èˆ‡ã€å…§æ–‡ã€å†é€²è¡Œå®Œæ•´åˆ†æ\u3000ğŸš¨ ", "", "", "", "", "", "", "", "", ""
        return 
    
    yield " ï¼»1/4ï¼½æ­£åœ¨æœå°‹ MGP è³‡æ–™åº«... ", "", "", "", "", "", title, content, "", ""
    
    ### MGP Part
    mgp_html_title_update, mgp_html_output_update, mgp_description, mgp_search_cnt, mgp_html_code = update_mgp_part(title, content)
    detail = f"\n<h3 style='color: #FF8F59;'>MGP è³‡æ–™æœå°‹çµæœï¼š</h3>\n\n"
    detail += mgp_description + "\n\n"
    
    if bool(mgp_search_cnt):
        increase = 33.333
        increase += ((mgp_search_cnt - 3) * 7.5) if increase > 3 else 0
        score += increase
        print(f"\n[MGP] : score += {increase:.3f}, current score = {score}\n")
    
    yield " ï¼»2/4ï¼½ MGP è³‡æ–™åº«æ¯”å°å®Œæˆï¼Œæ­£åœ¨æª¢æŸ¥é‚è¼¯çŸ›ç›¾... ", detail, mgp_html_title_update, mgp_html_output_update, "", "", title, content, mgp_html_code, ""
    
    ### Contradiction Part
    contrad_html_title_update, contrad_html_output_update, contrad_description, contrad_search_cnt, contrad_html_code = update_contradiction_part(title, content)
    detail += f"\n<h3 style='color: #FF8F59;'>ä¸‰å…ƒçµ„æœå°‹çŸ›ç›¾çµæœï¼š</h3>\n\n"
    detail += contrad_description + "\n\n"
    
    if bool(contrad_search_cnt):
        increase = 33.333
        increase += ((contrad_search_cnt - 5) * 7.5) if increase > 5 else 0
        score += increase
        print(f"\n[CONTRAD] : score += {increase:.3f}, current score = {score}\n")

    yield " ï¼»3/4ï¼½é‚è¼¯çŸ›ç›¾æ¯”å°å®Œæˆï¼Œæ­£åœ¨åˆ†ææ¨™é¡Œèˆ‡å…§æ–‡... ", detail, mgp_html_title_update, mgp_html_output_update, contrad_html_title_update, contrad_html_output_update, title, content, mgp_html_code, contrad_html_code

    news_sentences, title_dict, sentences_dict, sentence_summary_scores, prob = get_all_scores(title, content)
    print(f"\n[BERT] : prob = {prob * 100}\n")

    score += prob * 100
    score = min(score, 99.999)
    
    judgment = "" if 15 <= score <= 67 else "\n\t"
    judgment += f"ã€ {fake_score_transform(score)} ã€‘ "

    # if score > 67:
    #     judgment = f"ã€ {fake_score_transform(score)} ã€‘ "
    # elif score < 15:
    #     judgment = f"ã€ {fake_score_transform(score)} ã€‘ "
    # else:
    #     judgment = f"\n\tã€ {fake_score_transform(score)} ã€‘"
    
    # summary = "========================================\n\n"
    # summary += f"      ã€” é æ¸¬ç‚ºå‡æ–°èçš„æ©Ÿç‡ ï¼š {score:.3f} ï¼… ã€•   \n\n"
    # summary += f"ç¶“éç³»çµ±åˆ¤æ–·æ­¤æ–°èç‚º  {judgment}\n\n"
    # summary += "========================================\n\n"
    # summary += "      ã€” å¥å­ç¶œåˆåˆ†æ•¸ ã€•   \n\n"
    
    # sentence_summary_score_dict = sentence_score_transform(sentence_summary_scores)
    # for k, v in sentence_summary_score_dict.items():
    #     summary += f"  ãƒ» {k}{v}  \n\n"
    # summary += "========================================"

    summary = update_summary_part(score, sentence_summary_scores)
    
    detail += "<h3 style='color: #FF8F59;'>æ¨™é¡Œåˆ†æï¼š</h3>\n\n"
    title_score_dict = title_score_transform(title_dict)
    for k, v in title_score_dict.items():
        detail += f"- {k}{v}\n"

    detail += "\n\n<h3 style='color: #FF8F59;'>å…§æ–‡å¥å­åˆ†æï¼š</h3>\n"
    for sent in news_sentences:
        detail += f"\n> {sent}\n"
        sentence_score_dict = sentence_score_transform(sentences_dict[sent])
        for term in ['æƒ…æ„Ÿåˆ†æ', 'ä¸»è§€æ€§']:
            detail += f"- {term}{sentence_score_dict[term]}\n"

    yield summary, detail, mgp_html_title_update, mgp_html_output_update, contrad_html_title_update, contrad_html_output_update, title, content, mgp_html_code, contrad_html_code

def quick_interface_fn(title, content):
    print("\n\n======  é–‹å§‹å¿«é€Ÿåˆ†æ  ======\n\n")
    score = 0

    title, content = re.sub(r'\s+', '', title), re.sub(r'\s+', '', content)
    if not isinstance(content, str) or content == "":
        yield " ğŸš¨\u3000è«‹è¼¸å…¥ã€å…§æ–‡ã€å†é€²è¡Œå¿«é€Ÿåˆ†æ\u3000ğŸš¨ ", "", "", "", "", "", "", "", "", ""
        return 
    
    yield " ï¼»1/3ï¼½æ­£åœ¨æœå°‹ MGP è³‡æ–™åº«... ", "", "", "", "", "", title, content, "", ""


    ### MGP Part
    mgp_html_title_update, mgp_html_output_update, mgp_description, mgp_search_cnt, mgp_html_code = update_mgp_part(title, content)
    detail = f"\n<h3 style='color: #FF8F59;'>MGP è³‡æ–™æœå°‹çµæœï¼š</h3>\n\n"
    detail += mgp_description + "\n\n"

    if bool(mgp_search_cnt):
        increase = 33.333
        increase += ((mgp_search_cnt - 3) * 7.5) if increase > 3 else 0
        score += increase
        print(f"\n[MGP] : score += {increase:.3f}, current score = {score}\n")
    
    yield " ï¼»2/3ï¼½ MGP è³‡æ–™åº«æ¯”å°å®Œæˆï¼Œæ­£åœ¨åˆ†ææ¨™é¡Œèˆ‡å…§æ–‡... ", detail, mgp_html_title_update, mgp_html_output_update, "", "", title, content, mgp_html_code, ""

    news_sentences, title_dict, sentences_dict, sentence_summary_scores, prob = get_all_scores(title, content)
    print(f"\n[BERT] : prob = {prob * 100}\n")
    
    score += prob * 100
    score = min(score, 99.999)
        

    judgment = "" if 15 <= score <= 67 else "\n\t"
    judgment += f"ã€ {fake_score_transform(score)} ã€‘ "

    # if score > 67:
    #     judgment = f"ã€ {fake_score_transform(score)} ã€‘ "
    # elif score < 15:
    #     judgment = f"ã€ {fake_score_transform(score)} ã€‘ "
    # else:
    #     judgment = f"\n\tã€ {fake_score_transform(score)} ã€‘"
    
    # summary = "========================================\n\n"
    # summary += f"      ã€” é æ¸¬ç‚ºå‡æ–°èçš„æ©Ÿç‡ ï¼š {score:.3f} ï¼… ã€•   \n\n"
    # summary += f"ç¶“éç³»çµ±åˆ¤æ–·æ­¤æ–°èç‚º  {judgment}\n\n"
    # summary += "========================================\n\n"
    # summary += "      ã€” å¥å­ç¶œåˆåˆ†æ•¸ ã€•   \n\n"
    
    # sentence_summary_score_dict = sentence_score_transform(sentence_summary_scores)
    # for k, v in sentence_summary_score_dict.items():
    #     summary += f"  ãƒ» {k}{v}  \n\n"
    # summary += "========================================"

    summary = update_summary_part(score, sentence_summary_scores)
    
    detail += "<h3 style='color: #FF8F59;'>æ¨™é¡Œåˆ†æï¼š</h3>\n\n"
    title_score_dict = title_score_transform(title_dict)
    for k, v in title_score_dict.items():
        detail += f"- {k}{v}\n"

    detail += "\n\n<h3 style='color: #FF8F59;'>å…§æ–‡å¥å­åˆ†æï¼š</h3>\n"
    for sent in news_sentences:
        detail += f"\n> {sent}\n"
        sentence_score_dict = sentence_score_transform(sentences_dict[sent])
        for term in ['æƒ…æ„Ÿåˆ†æ', 'ä¸»è§€æ€§']:
            detail += f"- {term}{sentence_score_dict[term]}\n"

    yield summary, detail, mgp_html_title_update, mgp_html_output_update, "", "", title, content, mgp_html_code, ""

with gr.Blocks() as demo:
    # gr.Markdown("# DeFake-ZH")
    with gr.Row():
        with gr.Column():
            # gr.Markdown('<div align="center"><h1>DeFake-ZH</h1></div>')
            # gr.Markdown('<div align="center"><h1 style="color: #FF4500;">DeFake-ZH</h1></div>')
            gr.Markdown('<div align="center"><h1 style="color: #FF8F59; font-size: 48px;">DeFake-ZH</h1></div>')
            gr.Markdown('<div align="center">è¼¸å…¥ä¸€ç¯‡æ–°èæ¨™é¡Œèˆ‡å…§æ–‡ï¼Œç³»çµ±å°‡åˆ¤æ–·çœŸå‡æ©Ÿç‡èˆ‡åˆ†æèªæ°£</div>')
            # title_markdown = gr.Markdown("## ä¸­æ–‡å‡æ–°èåµæ¸¬å™¨")
            # desc_markdown = gr.Markdown("è¼¸å…¥ä¸€ç¯‡æ–°èæ¨™é¡Œèˆ‡å…§æ–‡ï¼Œç³»çµ±å°‡åˆ¤æ–·çœŸå‡æ©Ÿç‡èˆ‡åˆ†æèªæ°£")
        # with gr.Column(scale=1, min_width=150):
        #     lang = gr.Dropdown(["ç¹é«”ä¸­æ–‡", "English"], label="", value="ç¹é«”ä¸­æ–‡")
        
    # title_markdown = gr.Markdown("## ä¸­æ–‡å‡æ–°èåµæ¸¬å™¨")
    # desc_markdown = gr.Markdown("è¼¸å…¥ä¸€ç¯‡æ–°èæ¨™é¡Œèˆ‡å…§æ–‡ï¼Œç³»çµ±å°‡åˆ¤æ–·çœŸå‡æ©Ÿç‡èˆ‡åˆ†æèªæ°£")

    with gr.Row():
        with gr.Column():
            title_input = gr.Textbox(label="æ–°èæ¨™é¡Œ")
            content_input = gr.Textbox(label="æ–°èå…§æ–‡", lines=6)
            with gr.Row():
                clear_btn = gr.Button(value="-- æ¸…é™¤ --")
                quick_btn = gr.Button(value="-- å¿«é€Ÿåˆ†æ --")
                submit_btn = gr.Button(value="-- å®Œæ•´åˆ†æ --")
                

        with gr.Column():
            output_summary = gr.HTML()
            with gr.Accordion(label=" é»æˆ‘å±•é–‹æŸ¥çœ‹è©³ç´°åˆ†æ ", open=False) as accordion_box:
                output_detail = gr.Markdown()
    
    hidden_title_textbox = gr.Textbox(value = "", visible = False)
    hidden_content_textbox = gr.Textbox(value = "", visible = False)
    hidden_mgp_textbox = gr.Textbox(value = "", visible = False)
    hidden_contrad_textbox = gr.Textbox(value = "", visible = False)

    ## MGP Part
    mgp_html_title = gr.HTML()
    mgp_html_output = gr.HTML()
    set_mgp_hidden_button(mgp_html_output, hidden_title_textbox, hidden_content_textbox, hidden_mgp_textbox)
    
    ## Contradiction Part 
    contradictory_html_title = gr.HTML()
    contradictory_html_output = gr.HTML()
    set_contradiction_hidden_button(contradictory_html_output, hidden_title_textbox, hidden_content_textbox, hidden_contrad_textbox)
    

    disclaimer_text = gr.Markdown(lang_options["ç¹é«”ä¸­æ–‡"]["disclaimer"])
    
    # lang.change(
    #     update_labels,
    #     inputs=lang,

    #     outputs=[
    #         title_input, content_input, output_summary,
    #         submit_btn, quick_btn, clear_btn,
    #         title_markdown, desc_markdown,
    #         accordion_box,
    #         disclaimer_text
    #     ]
    # )

    quick_btn.click(
        fn=quick_interface_fn,
        inputs=[title_input, content_input],
        outputs=[output_summary, output_detail, mgp_html_title, mgp_html_output, 
        contradictory_html_title, contradictory_html_output, 
        hidden_title_textbox, hidden_content_textbox, hidden_mgp_textbox, hidden_contrad_textbox]
    )
    
    submit_btn.click(
        fn=interface_fn,
        inputs=[title_input, content_input],
        outputs=[output_summary, output_detail, mgp_html_title, mgp_html_output, 
        contradictory_html_title, contradictory_html_output, 
        hidden_title_textbox, hidden_content_textbox, hidden_mgp_textbox, hidden_contrad_textbox]
    )

    clear_btn.click(
        fn=lambda: ("", "", "", "", "", "", "", "", "", "", "", ""),
        outputs=[title_input, content_input, output_summary, output_detail, 
                 mgp_html_title, mgp_html_output, contradictory_html_title, contradictory_html_output, 
                 hidden_title_textbox, hidden_content_textbox, hidden_mgp_textbox, hidden_contrad_textbox]
    )


if __name__ == "__main__":
    demo.launch(share=False)
